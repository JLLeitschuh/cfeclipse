<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <meta http-equiv="Content-Style-Type" content="text/css">
   <script src="pages.js" type="text/javascript" language="Javascript1.2" charset="UTF-8"></script>
   <title>Using an LDAP directory for security information</title>
</head>
<body>
<p align="right"><p align="right"><a href="00001193.htm"><img src="images/previous.gif" width="9" height="14" border="0" alt="Previous"></a>&nbsp;&nbsp;<a href="00001195.htm"><img src="images/next.gif" width="9" height="14" border="0" alt="Next"></a>
</p></p>
<hr />
<h1>Using an LDAP directory for security information</h1>
<p>LDAP directories are often used to store security information. The following example of a <code>cflogin</code> tag checks an LDAP directory to authenticate the user and retrieve the user's roles.</p>
<p>For more information on using LDAP directories with ColdFusion, see <a href="00001282.htm#1128431">Managing LDAP Directories</a>.</p>
<pre>&lt;cfapplication name=&quot;Orders&quot; sessionmanagement=&quot;Yes&quot; loginstorage=&quot;Session&quot;&gt;
&lt;cflogin&gt;
   &lt;cfif isDefined(&quot;cflogin&quot;)&gt;
      &lt;!--- setting basic attributes ---&gt;
      &lt;cfset LDAP_root = &quot;o=mycompany.com&quot;&gt;
      &lt;cfset LDAP_server = &quot;ldap.mycompany.com&quot;&gt;
      &lt;cfset LDAP_port = &quot;389&quot;&gt;
      
      &lt;!--- Create the prefix and suffix parts of the user&#39;s DN. ---&gt;
      &lt;cfset userPrefix = &quot;cn=&quot;&gt;
      &lt;cfset userSuffix = &quot;,ou=Users,o=mycompany.com&quot;&gt;
      
      &lt;!--- Concatenate the user&#39;s DN and use it to authenticate. ---&gt;
      &lt;cfset LDAP_username = userPrefix&amp;cflogin.name&amp;userSuffix&gt;

      &lt;!--- This filter will look for groups for containing the user&#39;s ID. ---&gt;
      &lt;cfset userfilter =
         &quot;(&amp;(objectClass=groupOfUniqueNames)(uniqueMember=#LDAP_username#))&quot;&gt;

      &lt;!--- Search for groups containing the user&#39;s dn. 
         The groups represent the user&#39;s roles.
         NOTE: Your LDAP permissions must allow authenticated users to search.
         groups. ---&gt;
      &lt;cftry&gt;
         &lt;cfldap action=&quot;QUERY&quot;
            name=&quot;auth&quot;
            attributes=&quot;cn&quot;
            referral=&quot;yes&quot;
            start=&quot;#LDAP_root#&quot;
            scope=&quot;SUBTREE&quot;
            server=&quot;#LDAP_server#&quot;
            port=&quot;#LDAP_port#&quot;
            filter=&quot;#userfilter#&quot;
            username=&quot;#LDAP_username#&quot;
            password=&quot;#cflogin.password#&quot;
         &gt; 
          &lt;cfcatch type=&quot;any&quot;&gt;
            &lt;cfif FindNoCase(&quot;Invalid credentials&quot;, cfcatch.detail)&gt;
               &lt;cfoutput&gt;
                  &lt;script&gt;alert(&quot;User ID or Password invalid for user:
                     #cflogin.name#&quot;)&lt;/script&gt;
               &lt;/cfoutput&gt;
               &lt;cfabort&gt;
            &lt;cfelse&gt;
               &lt;cfoutput&gt;
                  &lt;script&gt;alert(&quot;Unknown error for user: #cflogin.name#
                     #cfcatch.detail#&quot;)&lt;/script&gt;
               &lt;/cfoutput&gt;
               &lt;cfabort&gt;
            &lt;/cfif&gt;
         &lt;/cfcatch&gt;
      &lt;/cftry&gt;
   
&lt;!--- If the LDAP query returned a record, the user is valid. ---&gt;
      &lt;cfif auth.recordcount&gt;
         &lt;cfloginuser name=&quot;#cflogin.name#&quot; password=&quot;#cflogin.password#&quot;
            roles=&quot;#valueList(auth.cn)#&quot;&gt;
      &lt;/cfif&gt;
   &lt;/cfif&gt;
&lt;/cflogin&gt;
</pre><h4><a name="wp1124705"></a>Reviewing the code</h4>
<p>The following table describes the code and its function. Comments and some tab characters have been removed for brevity.</p>
<table border="0" cellpadding="0" cellspacing="0">
  <tr>
    <th>
Code
    </th>
    <th>
Description
    </th>
  </tr>
  <tr>
    <td>
<pre>&lt;cflogin&gt;
   &lt;cfif isDefined(&quot;cflogin&quot;)&gt;
      &lt;!--- setting basic attributes ---&gt;
      &lt;cfset LDAP_root = &quot;o=mycompany.com&quot;&gt;
      &lt;cfset LDAP_server =
         &quot;ldap.mycompany.com&quot;&gt;
      &lt;cfset LDAP_port = &quot;389&quot;&gt;
      
      &lt;cfset userPrefix = &quot;cn=&quot;&gt;
      &lt;cfset userSuffix =
         &quot;,ou=Users,o=mycompany.com&quot;&gt;
      
      &lt;cfset LDAP_username =
         userPrefix&amp;cflogin.name&amp;userSuffix&gt;



      &lt;cfset userfilter =
         &quot;(&amp;(objectClass=groupOfUniqueNames)
         (uniqueMember=#LDAP_username#))&quot;&gt;
</pre>    </td>
    <td>
<p>Starts the <code>cflogin</code> tag body. Sets several variables to the values used as attributes in the <code>cfldap</code> tag. </p>
<p>&#160;</p>
<p>&#160;</p>
<p>&#160;</p>
<p>Sets prefix and suffix values used to create a distinquished name (dn) for binding to the LDAP server. </p>
<p>&#160;</p>
<p>Creates the user's bind dn by concatenating the prefix and suffix with cflogin.name. This variable is used for authenticating the user to the LDAP server.</p>
<p>Sets the filter used to search the directory and retrieve the user's group memberships. The group membership represents the user's roles within the organization.</p>
    </td>
  </tr>
  <tr bgcolor="#F8F8F8">
    <td>
<pre>&lt;cftry&gt;
   &lt;cfldap action=&quot;QUERY&quot;
      name=&quot;auth&quot;
      attributes=&quot;cn&quot;
      referral=&quot;yes&quot;
      start=&quot;#LDAP_root#&quot;
      scope=&quot;SUBTREE&quot;
      server=&quot;#LDAP_server#&quot;
      port=&quot;#LDAP_port#&quot;
      filter=&quot;#userfilter#&quot;
      username=&quot;#LDAP_username#&quot;
      password=&quot;#cflogin.password#&quot;
   &gt;
</pre>    </td>
    <td>
<p>In a <code>cftry</code> block, uses the user's concatenated dn to authenticate to the LDAP server and retrieve the common name (cn) attribute for groups to which the user is a member. If the authentication fails the LDAP server returns an error.</p>
<p>&#160;</p>
<p>Note: The LDAP permissions must allow an authenticated user to read and search groups in order for the query to return results.</p>
    </td>
  </tr>
  <tr>
    <td>
<pre>&lt;cfcatch type=&quot;any&quot;&gt;
   &lt;cfif FindNoCase(&quot;Invalid credentials&quot;,
         cfcatch.detail)&gt;
      &lt;cfoutput&gt;
         &lt;script&gt;alert(&quot;User ID or Password
            invalid for user:
            #cflogin.name#&quot;)&lt;/script&gt;
      &lt;/cfoutput&gt;
      &lt;cfabort&gt;
   &lt;cfelse&gt;
      &lt;cfoutput&gt;
      &lt;script&gt;alert(&quot;Unknown error for user:
         #cflogin.name#
         #cfcatch.detail#&quot;)&lt;/script&gt;
      &lt;/cfoutput&gt;
      &lt;cfabort&gt;
   &lt;/cfif&gt;
&lt;/cfcatch&gt;
&lt;/cftry&gt;
</pre>    </td>
    <td>
<p>Catches any exceptions. </p>
<p>Tests to see if the error information includes the string &quot;invalid credentials&quot;, which indicates that either the dn or password is invalid. If so, displays a dialog box with an error message indicating the problem. </p>
<p>&#160;</p>
<p>&#160;</p>
<p>Otherwise, displays a general error message.</p>
<p>&#160;</p>
<p>&#160;</p>
<p>&#160;</p>
<p>If an error is caught, the <code>cfabort</code> tag ends processing of the request after displaying the error description.</p>
<p>End of <code>cfcatch</code> and <code>cftry</code> blocks.</p>
    </td>
  </tr>
  <tr bgcolor="#F8F8F8">
    <td>
<pre>&lt;cfif auth.recordcount&gt;
   &lt;cfloginuser name=&quot;#cflogin.name#&quot;
      password=&quot;#cflogin.password#&quot;
      roles=&quot;#valueList(auth.cn)#&quot;&gt;
&lt;/cfif&gt;
&lt;/cfif&gt;
&lt;/cflogin&gt;
</pre>    </td>
    <td>
<p>If the authorization query returns a valid record, logs in the user. Uses the <code>valueList</code> function to create a comma-separated list of the users retrieved group memberships, and passes them in the <code>cfloginuser</code> <code>roles</code> attribute.</p>
<p>Ends the initial <code>isDefined(&quot;cflogin&quot;)</code> <code>cfif</code> block .</p>
<p>Ends the <code>cflogin</code> tag body</p>
    </td>
  </tr>
</table>

<p></p>


<hr />
<p align="right"><p align="right"><a href="00001193.htm"><img src="images/previous.gif" width="9" height="14" border="0" alt="Previous"></a>&nbsp;&nbsp;<a href="00001195.htm"><img src="images/next.gif" width="9" height="14" border="0" alt="Next"></a>
</p></p>
<p><a href="http://livedocs.macromedia.com/coldfusion/7/htmldocs/00001194.htm" target="mm_window">View comments in LiveDocs</a></p>
 </body>
</html>




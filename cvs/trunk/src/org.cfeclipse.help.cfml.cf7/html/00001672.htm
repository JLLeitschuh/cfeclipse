<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <meta http-equiv="Content-Style-Type" content="text/css">
   <script src="pages.js" type="text/javascript" language="Javascript1.2" charset="UTF-8"></script>
   <title>Handling incoming messages</title>
</head>
<body>
<p align="right"><p align="right"><a href="00001671.htm"><img src="images/previous.gif" width="9" height="14" border="0" alt="Previous"></a>&nbsp;&nbsp;<a href="00001673.htm"><img src="images/next.gif" width="9" height="14" border="0" alt="Next"></a>
</p></p>
<hr />
<h1>Handling incoming messages</h1>
<p>The SMS event gateway handles messages that are contained in deliver_sm PDUs. These PDUs request the gateway to deliver one of the following types of message:</p>
<ul>
<li>
   A user- or application-generated text message
</li>
<li>
   A message disposition response
</li>
</ul>
<p><strong>Note: </strong>The SMS event gateway does not handle messages that are contained in data_sm PDUs. </p><p>The event gateway sends the object to event gateway services, which delivers it to the listener CFC. The CFEvent object that the listener CFC receives contains the following fields:</p>
<table border="0" cellpadding="0" cellspacing="0">
  <tr>
    <th>
Field 
    </th>
    <th>
Value
    </th>
  </tr>
  <tr>
    <td>
<p>CfcMethod</p>
    </td>
    <td>
<p>Listener CFC method name</p>
    </td>
  </tr>
  <tr bgcolor="#F8F8F8">
    <td>
<p>Data.dataCoding</p>
    </td>
    <td>
<p>Character set or the noncharacter data type of the message contents</p>
    </td>
  </tr>
  <tr>
    <td>
<p>Data.destAddress</p>
    </td>
    <td>
<p>Address to which the message was sent</p>
    </td>
  </tr>
  <tr bgcolor="#F8F8F8">
    <td>
<p>Data.esmClass</p>
    </td>
    <td>
<p>Message type</p>
    </td>
  </tr>
  <tr>
    <td>
<p>Data.MESSAGE</p>
    </td>
    <td>
<p>Message contents</p>
    </td>
  </tr>
  <tr bgcolor="#F8F8F8">
    <td>
<p>Data.messageLength</p>
    </td>
    <td>
<p>Length of the MESSAGE field</p>
    </td>
  </tr>
  <tr>
    <td>
<p>Data.priority</p>
    </td>
    <td>
<p>Message priority level, in the range 0-3</p>
    </td>
  </tr>
  <tr bgcolor="#F8F8F8">
    <td>
<p>Data.protocol</p>
    </td>
    <td>
<p>GSM protocol; not used for other networks</p>
    </td>
  </tr>
  <tr>
    <td>
<p>Data.registeredDelivery</p>
    </td>
    <td>
<p>Requested type of delivery receipt or acknowledgement, if any</p>
    </td>
  </tr>
  <tr bgcolor="#F8F8F8">
    <td>
<p>Data.sourceAddress</p>
    </td>
    <td>
<p>Address of the device that sent this message</p>
    </td>
  </tr>
  <tr>
    <td>
<p>GatewayType</p>
    </td>
    <td>
<p>Always SMS</p>
    </td>
  </tr>
  <tr bgcolor="#F8F8F8">
    <td>
<p>OriginatorID</p>
    </td>
    <td>
<p>Address of the device that sent the message</p>
    </td>
  </tr>
</table>

<p>For a detailed description of each field, see <a href="00000778.htm#1201276">SMS Gateway incoming message CFEvent structure</a> in <i>CFML Reference</i>.</p>
<p>The CFC's listener method extracts the message from the Arguments.CFEvent.Data.MESSAGE field and acts on it as appropriate for the application. If necessary, the listener can use two fields to determine the required action:</p>
<ul>
<li>
   CFEvent.Data.esmClass indicates the type of information in the MESSAGE field.
</li>
<li>
   CFEvent.Data.registeredDelivery indicates whether the sender requested any type of delivery receipt or acknowledgement.
</li>
</ul>
<h2><a name="wp143048"></a>CFEvent.Data.esmClass field</h2>
<p>The CFEvent.Data.esmClass field identifies whether the CFEvent.Data.Message field contains a message, or any of the following types of message disposition responses. For these responses, the CFEvent object Data.MESSAGE field contains the acknowledgment or receipt information.</p>
<p><strong>SMSC Delivery Receipt</strong>&#160;An indication of the message's final status, sent by the SMSC. The short message text includes the message ID of the original message, the number of messages sent and delivered (for messages sent to a distribution list), the date and time that the message was sent and delivered or otherwise disposed of, the message disposition, a network-specific error code (if available), and the first 20 bytes of the message. For details of the SMSC delivery receipt message structure, see Appendix B of the SMS 3.4 specification.</p>
<p><strong>SME Delivery Acknowledgement</strong>&#160;An indication from the recipient device that the user has read the short message. Supported by TDMA and CDMA wireless networks only.</p>
<p><strong>SME Manual/User Acknowledgement</strong>&#160;An application-generated reply message sent in response to an application request message. Supported by TDMA and CDMA wireless networks only.</p>
<p><strong>Intermediate Delivery Notification</strong>&#160;A provider-specific notification on the status of a message that has not yet been delivered, sent during the SMSC retry lifetime for the message. Intermediate Notification support depends on the SMSC implementation and SMSC service provider. For more information, see your provider documentation.</p>
<p>When you send a message, you can request any combination of message disposition responses in the outgoing message's <code>registered_delivery</code> parameter. If your application requests responses, the listener CFC must be prepared to handle these messages, as appropriate.</p>
<h2><a name="wp139057"></a>CFEvent.Data.registeredDelivery field</h2>
<p>The CFEvent.Data.registeredDelivery field indicates whether the message sender has requested a receipt or acknowledgment. Your application can respond to a request for an SME Delivery Acknowledgement or an SME Manual/User Acknowledgement. (The other notification types are sent by the SMSC only.) For more information on these notification types, see the SMS 3.4 specification. Appendix B contains detailed information on the information that you must put in the shortMessage field of the returned acknowledgment message.</p>
<h2><a name="wp143093"></a>Incoming message handling example</h2>
<p>The following example code is an SMS-only version of the echo.cfc example that is included in the ColdFusion MX gateway/cfc/examples directory. This example shows the minimal code needed to receive and respond to an SMS message.</p>
<pre>&lt;cfcomponent displayname=&quot;echo&quot; hint=&quot;Process events from the test gateway and return echo&quot;&gt;
&lt;cffunction name=&quot;onIncomingMessage&quot; output=&quot;no&quot;&gt;
   &lt;cfargument name=&quot;CFEvent&quot; type=&quot;struct&quot; required=&quot;yes&quot;&gt;
   &lt;!--- Get the message ---&gt;
   &lt;cfset data=cfevent.DATA&gt;
   &lt;cfset message=&quot;#data.message#&quot;&gt;
   &lt;!--- where did it come from? ---&gt;
   &lt;cfset orig=&quot;#CFEvent.originatorID#&quot;&gt;
   &lt;cfset retValue = structNew()&gt;
   &lt;cfset retValue.command = &quot;submit&quot;&gt;
   &lt;cfset retValue.sourceAddress = arguments.CFEVENT.gatewayid&gt;
   &lt;cfset retValue.destAddress = arguments.CFEVENT.originatorid&gt;
   &lt;cfset retValue.shortMessage = &quot;echo: &quot; &amp; message&gt;
   &lt;!--- send the return message back ---&gt;
   &lt;cfreturn retValue&gt;
&lt;/cffunction&gt;
&lt;/cfcomponent&gt;
</pre>

<hr />
<p align="right"><p align="right"><a href="00001671.htm"><img src="images/previous.gif" width="9" height="14" border="0" alt="Previous"></a>&nbsp;&nbsp;<a href="00001673.htm"><img src="images/next.gif" width="9" height="14" border="0" alt="Next"></a>
</p></p>
<p><a href="http://livedocs.macromedia.com/coldfusion/7/htmldocs/00001672.htm" target="mm_window">View comments in LiveDocs</a></p>
 </body>
</html>




<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <meta http-equiv="Content-Style-Type" content="text/css">
   <script src="pages.js" type="text/javascript" language="Javascript1.2" charset="UTF-8"></script>
   <title>Example: using XML in a ColdFusion application</title>
</head>
<body>
<p align="right"><p align="right"><a href="00001521.htm"><img src="images/previous.gif" width="9" height="14" border="0" alt="Previous"></a>&nbsp;&nbsp;<a href="00001523.htm"><img src="images/next.gif" width="9" height="14" border="0" alt="Next"></a>
</p></p>
<hr />
<h1>Example: using XML in a ColdFusion application</h1>
<p>The example in this section shows how you can use XML to represent data, and how ColdFusion can use XML data in an application. Although the example is too simple to be used in an application without substantial changes, it presents some of the common uses of XML with ColdFusion.</p>
<p>The example receives an order in the form of an XML document, processes it, and generates an XML receipt document. In this case, the order document is in a file, but it could be received as the result of an HTTP request, or retrieved using <code>cfpop</code>, <code>cfftp</code>, or other methods. The ColdFusion page does the following with the order:</p>
<ol>
<li>
   Generates a query object from an XML document.
</li>
<li>
   Queries a database table to determine the order discount percentage to use.
</li>
<li>
   Uses a query of queries to calculate the total price, then calculates the discounted price.
</li>
<li>
   Generates the receipt as an XML document.
</li>
</ol>
<p>This example displays the results of the processing steps to show you what has been done.</p>
<h4><a name="wp1210041"></a>The XML document</h4>
<p>The order.xml document has the following structure:</p>
<ul>
<li>
   The root element is named order and has one attribute, id.
</li>
<li>
   There is one customer element with firstname, lastname, and accountnum attributes. The customer element does not have a body
</li>
<li>
   There is one items element that contains multiple item elements
</li>
<li>
   Each item element has an id attribute and contains a name, quantity, and unitprice element. The name, quantity, and unitprice elements contain their value as body text.
</li>
</ul>
<p>The following order.xml document works correctly with the information in the cfdocexamples database:</p>
<pre>&lt;order id=&quot;4323251&quot;&gt;
   &lt;customer firstname=&quot;Philip&quot; lastname=&quot;Cramer&quot; accountNum=&quot;21&quot;/&gt;
   &lt;items&gt;
      &lt;item id=&quot;43&quot;&gt;
         &lt;name&gt;
            Large Hammer
         &lt;/name&gt;
         &lt;quantity&gt;
            1
         &lt;/quantity&gt;
         &lt;unitprice&gt;
            15.95
         &lt;/unitprice&gt;
      &lt;/item&gt;               
      &lt;item id=&quot;54&quot;&gt;
         &lt;name&gt;
            Ladder
         &lt;/name&gt;
         &lt;quantity&gt;
            2
         &lt;/quantity&gt;
         &lt;unitprice&gt;
            40.95
         &lt;/unitprice&gt;
      &lt;/item&gt;
      &lt;item id=&quot;68&quot;&gt;
         &lt;name&gt;
            Paint
         &lt;/name&gt;
         &lt;quantity&gt;
            10
         &lt;/quantity&gt;
         &lt;unitprice&gt;
            18.95
         &lt;/unitprice&gt;
      &lt;/item&gt;
   &lt;/items&gt;
&lt;/order&gt;
</pre><h4><a name="wp1140527"></a>The ColdFusion page</h4>
<p>The ColdFusion page looks like the following:</p>
<pre>&lt;!--- Convert file to XML document object ---&gt;
&lt;cffile action=&quot;read&quot; file=&quot;C:\CFusionMX7\wwwroot\examples\order.xml&quot; variable=&quot;myxml&quot;&gt;
&lt;cfset mydoc = XmlParse(myxml)&gt;

&lt;!--- Extract account number ---&gt;
 &lt;cfset accountNum=#mydoc.order.customer.XmlAttributes.accountNum#&gt;
&lt;!--- Display Order Information ---&gt;
&lt;cfoutput&gt;
   &lt;b&gt;Name=&lt;/b&gt;#mydoc.order.customer.XmlAttributes.firstname# 
        #mydoc.order.customer.XmlAttributes.lastname#
   &lt;br&gt;
   &lt;b&gt;Account=&lt;/b&gt;#accountNum#
   &lt;br&gt;
   &lt;cfset numItems = ArrayLen(mydoc.order.items.XmlChildren)&gt;
   &lt;b&gt;Number of items ordered=&lt;/b&gt; #numItems#
&lt;/cfoutput&gt;
&lt;br&gt;&lt;br&gt;

&lt;!--- Process the order into a query object ---&gt;
&lt;cfset orderquery = QueryNew(&quot;item_Id, name, qty, unitPrice&quot;) &gt;
&lt;cfset temp = QueryAddRow(orderquery, #numItems#)&gt;
&lt;cfloop index=&quot;i&quot; from = &quot;1&quot; to = #numItems#&gt;
   &lt;cfset temp = QuerySetCell(orderquery, &quot;item_Id&quot;,
      #mydoc.order.items.item[i].XmlAttributes.id#,#i#)&gt;
   &lt;cfset temp = QuerySetCell(orderquery, &quot;name&quot;,
      #mydoc.order.items.item[i].name.XmlText#, #i#)&gt;
   &lt;cfset temp = QuerySetCell(orderquery, &quot;qty&quot;,
      #mydoc.order.items.item[i].quantity.XmlText#, #i#)&gt;
   &lt;cfset temp = QuerySetCell(orderquery, &quot;unitPrice&quot;,
      #mydoc.order.items.item[i].unitprice.XmlText#, #i#)&gt;
&lt;/cfloop&gt;

&lt;!--- Display the order query ---&gt;
&lt;cfdump var=#orderquery#&gt;
&lt;br&gt;&lt;br&gt;

&lt;!--- Determine the discount ---&gt;
&lt;cfquery name=&quot;discountQuery&quot; datasource=&quot;cfdocexamples&quot;&gt;
   SELECT * 
   FROM employee 
   WHERE Emp_Id = #accountNum#
&lt;/cfquery&gt;
&lt;cfset drate = 0&gt;
&lt;cfif #discountQuery.RecordCount# is 1&gt;
   &lt;cfset drate = 10&gt;
&lt;/cfif&gt;

&lt;!--- Display the discount rate ---&gt;
&lt;cfoutput&gt;
   &lt;b&gt;Discount Rate =&lt;/b&gt; #drate#%
&lt;/cfoutput&gt;
&lt;br&gt;&lt;br&gt;

&lt;!--- Compute the total cost and discount price---&gt;
&lt;cfquery name=&quot;priceQuery&quot; dbType=&quot;query&quot;&gt;
   SELECT SUM(qty*unitPrice) 
   AS totalPrice 
   FROM orderquery
&lt;/cfquery&gt;
&lt;cfset discountPrice = priceQuery.totalPrice * (1 - drate/100)&gt;

&lt;!--- Display the full price and discounted price ---&gt;
&lt;cfoutput&gt;
   &lt;b&gt;Full Price=&lt;/b&gt; #priceQuery.totalPrice#&lt;br&gt;
   &lt;b&gt;Discount Price=&lt;/b&gt; #discountPrice#
&lt;/cfoutput&gt;
&lt;br&gt;&lt;br&gt;

&lt;!---Generate an XML Receipt ---&gt;
&lt;cfxml variable=&quot;receiptxml&quot;&gt;
&lt;receipt num = &quot;34&quot;&gt;
   &lt;cfoutput&gt;
      &lt;price&gt;#discountPrice#&lt;/price&gt;
      &lt;cfif drate GT 0 &gt;
      &#160;&#160;&lt;discountRate&gt;#drate#&lt;/discountRate&gt;
      &lt;/cfif&gt;
   &lt;/cfoutput&gt;
   &lt;itemsFilled&gt;   
      &lt;cfoutput query=&quot;orderQuery&quot;&gt;
            &lt;name&gt;   #name# &lt;/name&gt;
            &lt;qty&gt;   #qty# &lt;/qty&gt;
            &lt;price&gt; #qty*unitPrice# &lt;/price&gt;
      &lt;/cfoutput&gt;   
   &lt;/itemsFilled&gt;
&lt;/receipt&gt;
&lt;/cfxml&gt;

&lt;!--- Display the resulting receipt ---&gt;
&lt;cfdump var=#receiptxml#&gt;
</pre><h4><a name="wp1140898"></a>Reviewing the code</h4>
<p>The following table describes the CFML code and its function. For the sake of brevity, it does not include code that displays the processing results.</p>
<table border="0" cellpadding="0" cellspacing="0">
  <tr>
    <th>
Code
    </th>
    <th>
Description
    </th>
  </tr>
  <tr>
    <td>
<pre>&lt;cffile action=&quot;read&quot;<br />file=&quot;C:\CFusionMX7\wwwroot\examples\order.xml&quot;
   variable=&quot;myxml&quot;&gt;
&lt;cfset mydoc = XmlParse(myxml)&gt;
&lt;cfset accountNum=#mydoc.order.
   customer.XmlAttributes.accountNum#&gt;
</pre>    </td>
    <td>
<p>Reads the XML from a file and convert it to an XML document object.</p>
<p>&#160;</p>
<p>Sets the accountNum variable from the customer entry's accountnum attribute.</p>
    </td>
  </tr>
  <tr bgcolor="#F8F8F8">
    <td>
<pre>&lt;cfset orderquery = QueryNew(&quot;item_Id, 
   name, qty, unitPrice&quot;) &gt;
&lt;cfset temp = QueryAddRow(orderquery,
   #numItems#)&gt;
&lt;cfloop index=&quot;i&quot; from = &quot;1&quot; to = #numItems#&gt;
&#160;&#160;&lt;cfset temp = QuerySetCell(orderquery,
   &#160;&quot;item_Id&quot;, #mydoc.order.items.item[i].
   &#160;XmlAttributes.id#, #i#)&gt;
&#160;&#160;&lt;cfset temp = QuerySetCell(orderquery,
   &#160;&quot;name&quot;, #mydoc.order.items.item[i].
   &#160;name.XmlText#, #i#)&gt;
&#160;&#160;&lt;cfset temp = QuerySetCell(orderquery,
   &#160;&quot;qty&quot;, #mydoc.order.items.item[i].
   &#160;quantity.XmlText#, #i#)&gt;
&#160;&#160;&lt;cfset temp = QuerySetCell(orderquery,
   &#160;&quot;unitPrice&quot;, #mydoc.order.items.item[i].
   &#160;unitprice.XmlText#, #i#)&gt;
&lt;/cfloop&gt;
</pre>    </td>
    <td>
<p>Converts the XML document object into a query object. </p>
<p>Creates a query with columns for the item_id, name, qty, and unitPrice values for each item.</p>
<p>For each XML item entry in the mydoc.order.items entry, fills one row of the query with the item's id attribute and the text in the name, quantity, and unitprice entries that the it contains.</p>
    </td>
  </tr>
  <tr>
    <td>
<pre>&lt;cfquery name=&quot;discountQuery&quot;
   &#160;&#160;datasource=&quot;cfdocexamples&quot;&gt;
   SELECT * 
   FROM employee 
   WHERE Emp_Id = #accountNum#
&lt;/cfquery&gt;
&lt;cfset drate = 0&gt;
&lt;cfif #discountQuery.RecordCount# is 1&gt;
   &lt;cfset drate = 10&gt;
&lt;/cfif&gt;
</pre>    </td>
    <td>
<p>If the account number is the same as an employee ID in the cfdocexamples database Employee table, the query returns one record. and RecordCount equals 1. In this case, sets a discount rate of 10%. Otherwise, sets a discount rate of 0%. </p>
    </td>
  </tr>
  <tr bgcolor="#F8F8F8">
    <td>
<pre>&lt;cfquery name=&quot;priceQuery&quot; dbType=&quot;query&quot;&gt;
   SELECT SUM(qty*unitPrice) 
   AS totalPrice 
   FROM orderquery
&lt;/cfquery&gt;
&lt;cfset discountPrice = priceQuery.totalPrice
   * (1 - drate/100)&gt;
</pre>    </td>
    <td>
<p>Uses a query of queries with the SUM operator to calculate the total cost before discount of the ordered items, then applies the discount to the price. The result of the query is a single value, the total price.</p>
    </td>
  </tr>
  <tr>
    <td>
<pre>&lt;cfxml variable=&quot;receiptxml&quot;&gt;
&#160;&lt;receipt num = &quot;34&quot;&gt;
&#160;&#160;&lt;cfoutput&gt;
&#160;&#160;&#160;&lt;price&gt;#discountPrice#&lt;/price&gt;
&#160;&#160;&#160;&lt;cfif drate GT 0 &gt;
&#160;&#160;&#160;&#160;&lt;discountRate&gt;#drate#&lt;/discountRate&gt;
&#160;&#160;&#160;&#160;&lt;/cfif&gt;
&#160;&#160;&lt;/cfoutput&gt;
&#160;&#160;&lt;itemsFilled&gt;
&#160;&#160;&#160;&lt;cfoutput query=&quot;orderQuery&quot;&gt;
&#160;&#160;&#160;&#160;&lt;name&gt;   #name# &lt;/name&gt;
&#160;&#160;&#160;&#160;&lt;qty&gt;   #qty# &lt;/qty&gt;
&#160;&#160;&#160;&#160;&lt;price&gt; #qty*unitPrice# &lt;/price&gt;
&#160;&#160;&#160;&lt;/cfoutput&gt;   
&#160;&#160;&lt;/itemsFilled&gt;
&#160;&lt;/receipt&gt;
&lt;/cfxml&gt;
</pre>    </td>
    <td>
<p>Creates an XML document object as a receipt. The receipt has a root element named receipt, which has the receipt number as an attribute. The receipt element contains a price element with the order cost and an itemsFilled element with one item element for each item.</p>
    </td>
  </tr>
</table>
 


<hr />
<p align="right"><p align="right"><a href="00001521.htm"><img src="images/previous.gif" width="9" height="14" border="0" alt="Previous"></a>&nbsp;&nbsp;<a href="00001523.htm"><img src="images/next.gif" width="9" height="14" border="0" alt="Next"></a>
</p></p>
<p><a href="http://livedocs.macromedia.com/coldfusion/7/htmldocs/00001522.htm" target="mm_window">View comments in LiveDocs</a></p>
 </body>
</html>




<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <meta http-equiv="Content-Style-Type" content="text/css">
   <script src="pages.js" type="text/javascript" language="Javascript1.2" charset="UTF-8"></script>
   <title>Exercise 2: Building a query that uses dynamic SQL</title>
</head>
<body>
<p align="right"><p align="right"><a href="00000131.htm"><img src="images/previous.gif" width="9" height="14" border="0" alt="Previous"></a>&nbsp;&nbsp;<a href="00000133.htm"><img src="images/next.gif" width="9" height="14" border="0" alt="Next"></a>
</p></p>
<hr />
<h1>Exercise 2: Building a query that uses dynamic SQL</h1>
<p><i>Dynamic SQL</i> is a term that refers to SQL code that your program generates using variables before the SQL is executed. You can use dynamic SQL to accomplish tasks such as adding WHERE clauses to a search based on the fields that the user filled out on a search criteria page. </p>
<p>Based on the columns that you can query in this tutorial, the SQL query to display the search results would look like this:</p>
<pre>SELECT tripName,  tripLocation, departureDate, returnDate, price, tripID 
FROM trips
</pre><p>The purpose of the Trip Search form is to supply the data needed to build the WHERE clause to finish this SQL SELECT statement and constrain the query according to the user's input. </p>
<p>When the user enters the search criteria on the Trip Search form and clicks the Search button, the form fields are posted to the Trip Search Results page. The posted field values compose the WHERE clause in the SQL SELECT statement. The following example lists the WHERE clauses that you can generate depending on the criteria set on the search page:</p>
<pre>WHERE tripLocation = &#39;Aruba&#39;
WHERE tripLocation Like &#39;C%&#39;
WHERE tripLocation = &#39;China&#39; 
   AND departureDate &gt; 1/1/2001
   AND price &lt; 1500
</pre><p>In this example, the SQL AND operator joins the search condition clauses. To simplify the trip search example, you will use the SQL AND operator to combine all the search condition clauses. A more sophisticated search criteria page might present the user a choice of using AND or OR to connect one search criterion with the others.</p>
<p>The action page invokes a method that builds the WHERE clause so that the SQL SELECT statement retrieves the information that the user requests. Then, the action page displays an HTML table with the results of the user query using the <code>cfoutput</code> block. </p>
<h2><a name="wp1153059"></a>Building the WHERE Clause with the cfif and cfset tags</h2>
<p>The WHERE clause in a SQL SELECT statement is a string. You use the CFML <code>cfset</code> and <code>cfif</code> tags to conditionally build the WHERE clause depending on values passed to the search action page. The <code>cfset</code> statement creates a variable or changes the value of an existing variable. For example, to create a variable named color and initialize its value to red, you use the following statement:</p>
<pre>&lt;cfset color = &quot;red&quot;&gt;
</pre><p>The <code>cfif</code> tag instructs the program to branch to different parts of the code depending on whether a test evaluates to True or False. For example, to have some code execute if the color variable is equal to red, and other code execute if it is not, you use the following pseudocode:</p>
<pre>&lt;cfif color EQ &quot;red&quot;&gt;
... statements for color red
&lt;cfelse&gt;
... statements for other than red
&lt;/cfif&gt;
</pre><p>Building a SQL WHERE clause in code is largely an exercise in string concatenation. The <code>&amp;</code> operator combines two strings in ColdFusion. For example, the following code snippet:</p>
<pre>&lt;cfset FirstName = &quot;Wilson&quot;&gt;
&lt;cfset LastName = &quot;Gato&quot;&gt;
&lt;cfset FullName = FirstName &amp; &quot; &quot; &amp; LastName&gt;
&lt;cfoutput&gt;My name is #FullName#.&lt;/cfoutput&gt;
</pre><p>results in the following text:</p>
<pre>My name is Wilson Gato.
</pre><p>For each search criterion on the Trip Search form, the code within the Trip Search Results page must do the following: </p>
<ul>
<li>
   Verify that the user entered data in the search criterion's value field. To do so, you use the <code>cfif</code> tag; for example, <code>&lt;cfif Form.tripLocationValue GT &quot;&quot;&gt;</code>.
</li>
<li>
   If data was entered, construct a WHERE subclause by concatenating the following: 
<ul><li>The SQL keyword AND</li>
<li>The corresponding SQL column name (in the Trip Search example, tripLocation) for the search criterion </li>
<li>The SQL operator equivalent of the search query operator </li>
<li>The test value entered by the user</li>
</ul></li>
</ul>
<p>The following code shows the creation of the WHERE subclause:</p>
<pre>&lt;cfif Form.tripLocationOperator EQ &quot;EQUALS&quot;&gt;         
   &lt;cfset WhereClause = WhereClause &amp; &quot; AND tripLocation = &#39;&quot; &amp;
      form.tripLocationValue &amp; &quot;&#39;&quot; &gt;
&lt;cfelse&gt;
   &lt;cfset WhereClause = WhereClause &amp; &quot; AND tripLocation like &#39;&quot; &amp;
      form.tripLocationValue &amp; &quot;%&#39;&quot; &gt;
&lt;/cfif&gt;
</pre><p>When you test for a string column within the WHERE clause of the SQL SELECT statement, you must enclose the test value in quotation marks. </p>
<p>When you use a variable to construct a WHERE clause, you must preserve the quotation marks so that the database server does not return an error. To preserve the quotation marks, you must use the ColdFusion <code>PreserveSingleQuotes</code> function. The <code>PreserveSingleQuotes</code> function prevents ColdFusion from automatically escaping single-quotation marks contained in the variable string passed to the function.</p>
<p><strong>Note: </strong>The <code>cfqueryparam</code> tag also escapes single-quotation marks. For more information, see <i>CFML Reference</i>.</p>

<hr />
<p align="right"><p align="right"><a href="00000131.htm"><img src="images/previous.gif" width="9" height="14" border="0" alt="Previous"></a>&nbsp;&nbsp;<a href="00000133.htm"><img src="images/next.gif" width="9" height="14" border="0" alt="Next"></a>
</p></p>
<p><a href="http://livedocs.macromedia.com/coldfusion/7/htmldocs/00000132.htm" target="mm_window">View comments in LiveDocs</a></p>
 </body>
</html>




<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <meta http-equiv="Content-Style-Type" content="text/css">
   <script src="pages.js" type="text/javascript" language="Javascript1.2" charset="UTF-8"></script>
   <title>Examples of cflock</title>
</head>
<body>
<p align="right"><p align="right"><a href="00001171.htm"><img src="images/previous.gif" width="9" height="14" border="0" alt="Previous"></a>&nbsp;&nbsp;<a href="00001173.htm"><img src="images/next.gif" width="9" height="14" border="0" alt="Next"></a>
</p></p>
<hr />
<h1>Examples of cflock</h1>
<p>The following examples show how to use <a href="00000285.htm#1100787"><code>cflock</code></a> blocks in a variety of situations.</p>
<ul>
<li>
   <a href="00001172.htm#1155013">Example with application, server, and session variables</a>
</li>
<li>
   <a href="00001173.htm#1155147">Example of synchronizing access to a file system</a>
</li>
<li>
   <a href="00001174.htm#1155158">Example of protecting ColdFusion extensions</a>
</li>
</ul>
<h3><a name="wp1155013"></a>Example with application, server, and session variables</h3>
<p>This example shows how you can use <code>cflock</code> to guarantee the consistency of data updates to variables in the Application, Server, and Session scopes. </p>
<p>This example does not handle exceptions that arise if a lock times out. As a result, users see the default exception error page on lock time-outs.</p>
<p>The following sample code might be part of the Application.cfm file:</p>
<pre><code>&lt;</code>cfapplication name=&quot;ETurtle&quot;
   sessiontimeout=#createtimespan(0,1,30,0)#
   sessionmanagement=&quot;yes&quot;&gt;

&lt;!--- Initialize the Session and Application 
variables that will be used by E-Turtleneck. Use
the Session lock scope for the session variables. ---&gt;

&lt;cflock scope=&quot;Session&quot; 
   timeout=&quot;10&quot; type =&quot;Exclusive&quot;&gt;
   &lt;cfif not IsDefined(&quot;session.size&quot;)&gt;
      &lt;cfset session.size = &quot;&quot;&gt;
   &lt;/cfif&gt;
   &lt;cfif not IsDefined(&quot;session.color&quot;)&gt;
      &lt;cfset session.color = &quot;&quot;&gt;
   &lt;/cfif&gt;
&lt;/cflock&gt;

&lt;!--- Use the Application scope lock for the Application.number variable.
This variable keeps track of the total number of turtlenecks sold. 
The following code implements the scheme shown in the Locking Application 
variables effectively section ---&gt;

&lt;cfset app_is_initialized = &quot;no&quot;&gt;
&lt;cflock scope=&quot;Application&quot; type=&quot;readonly&quot;&gt;
   &lt;cfset app_is_initialized = IsDefined(&quot;Application.initialized&quot;)&gt;
&lt;/cflock&gt;
&lt;cfif not app_is_initialized &gt;
   &lt;cflock scope=&quot;application&quot; timeout=&quot;10&quot; type=&quot;exclusive&quot;&gt;
      &lt;cfif not IsDefined(&quot;Application.initialized&quot;) &gt;
         &lt;cfset Application.number = 1&gt;
         &lt;cfset Application.initialized = &quot;yes&quot;&gt;
      &lt;/cfif&gt;
   &lt;/cflock&gt;
&lt;/cfif&gt;

&lt;!--- Always display the number of turtlenecks sold ---&gt;

&lt;cflock scope=&quot;Application&quot; 
   timeout=&quot;10&quot; 
   type =&quot;ReadOnly&quot;&gt;
   &lt;cfoutput&gt;
   E-Turtleneck is proud to say that we have sold
   #Application.number# turtlenecks to date.
   &lt;/cfoutput&gt;
&lt;/cflock&gt;
</pre><p>The remaining sample code could appear inside the application page where customers place orders: </p>
<pre>&lt;html&gt;
&lt;head&gt;
&lt;title&gt;cflock Example&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
&lt;h3&gt;cflock Example&lt;/h3&gt;

&lt;cfif IsDefined(&quot;Form.submit&quot;)&gt;

&lt;!--- Lock session variables ---&gt;
&lt;!--- Note that we use the automatically generated Session 
   ID as the order ID ---&gt;
&lt;cflock scope=&quot;Session&quot;
   timeout=&quot;10&quot; type=&quot;ReadOnly&quot;&gt;
   &lt;cfoutput&gt;Thank you for shopping E-Turtleneck.
   Today you have chosen a turtleneck in size
   &lt;b&gt;#form.size#&lt;/b&gt; and in the color &lt;b&gt;#form.color#&lt;/b&gt;.
   Your order ID is #Session.sessionID#.
   &lt;/cfoutput&gt;
&lt;/cflock&gt;

&lt;!--- Lock session variables to assign form values to them. ---&gt;

&lt;cflock scope=&quot;Session&quot;
   timeout=&quot;10&quot; 
   type=&quot;Exclusive&quot;&gt;
   &lt;cfparam name=Session.size default=#form.size#&gt;
   &lt;cfparam name=Session.color default=#form.color#&gt;
&lt;/cflock&gt;
&lt;
!--- Lock the Application scope variable application.number to
update the total number of turtlenecks sold. ---&gt;

&lt;cflock scope=&quot;Application&quot;
   timeout=&quot;30&quot; type=&quot;Exclusive&quot;&gt;
   &lt;cfset application.number=application.number + 1&gt;
&lt;/cflock&gt;

&lt;!--- Show the form only if it has not been submitted. ---&gt;
&lt;cfelse&gt;
&lt;form action=&quot;cflock.cfm&quot; method=&quot;Post&quot;&gt;

&lt;p&gt; Congratulations! You have just selected
the longest-wearing, most comfortable turtleneck
in the world. Please indicate the color and size
you want to buy.&lt;/p&gt;

&lt;table cellspacing=&quot;2&quot; cellpadding=&quot;2&quot; border=&quot;0&quot;&gt;
&lt;tr&gt;
&lt;td&gt;Select a color.&lt;/td&gt;
&lt;td&gt;&lt;select type=&quot;Text&quot; name=&quot;color&quot;&gt;
      &lt;option&gt;red
      &lt;option&gt;white
      &lt;option&gt;blue
      &lt;option&gt;turquoise
      &lt;option&gt;black
      &lt;option&gt;forest green
      &lt;/select&gt;
   &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
   &lt;td&gt;Select a size.&lt;/td&gt;
   &lt;td&gt;&lt;select type=&quot;Text&quot; name=&quot;size&quot;&gt;
      &lt;option&gt;small
      &lt;option&gt;medium
      &lt;option&gt;large
      &lt;option&gt;xlarge
      &lt;/select&gt;
   &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
   &lt;td&gt;&lt;/td&gt;
   &lt;td&gt;&lt;input type=&quot;Submit&quot; name=&quot;submit&quot; value=&quot;Submit&quot;&gt;
   &lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/form&gt;
&lt;/cfif&gt;

&lt;/body&gt;
&lt;/html&gt;
</pre><p><strong>Note: </strong>In this simple example, the Application.cfm page displays the Application.number variable value. Because the Application.cfm file is processed before any code on each ColdFusion page, the number that displays after you click the submit button does not include the new order. One way you can resolve this problem is by using the OnRequestEnd.cfm page to display the value at the bottom of each page in the application.</p>

<hr />
<p align="right"><p align="right"><a href="00001171.htm"><img src="images/previous.gif" width="9" height="14" border="0" alt="Previous"></a>&nbsp;&nbsp;<a href="00001173.htm"><img src="images/next.gif" width="9" height="14" border="0" alt="Next"></a>
</p></p>
<p><a href="http://livedocs.macromedia.com/coldfusion/7/htmldocs/00001172.htm" target="mm_window">View comments in LiveDocs</a></p>
 </body>
</html>



